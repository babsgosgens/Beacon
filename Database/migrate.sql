ALTER TABLE objects ADD COLUMN tags CITEXT ARRAY DEFAULT '{}';

UPDATE engrams SET tags = '{}' WHERE tags != '{}';
UPDATE engrams SET tags = array_append(tags, 'blueprintable') WHERE can_blueprint = TRUE;
UPDATE engrams SET tags = array_append(tags, 'harvestable') WHERE class_string IN ('PrimalItemResource_BlueSap_C', 'PrimalItemResource_Silicate_C', 'PrimalItemResource_CondensedGas_C', 'PrimalItemResource_ElementDust_C', 'PrimalItemResource_RedSap_C', 'PrimalItemResource_FracturedGem_C', 'PrimalItemResource_ScrapMetal_C', 'PrimalItemResource_CorruptedPolymer_C', 'PrimalItemResource_ScrapMetalIngot_C', 'PrimalItemResource_Electronics_C', 'PrimalItemConsumable_RawMeat_C', 'PrimalItemConsumable_RawMeat_Fish_C', 'PrimalItemConsumable_RawPrimeMeat_C', 'PrimalItemConsumable_RawPrimeMeat_Fish_C', 'PrimalItemConsumable_Berry_Amarberry_C', 'PrimalItemConsumable_Berry_Azulberry_C', 'PrimalItemConsumable_Berry_Mejoberry_C', 'PrimalItemConsumable_Berry_Narcoberry_C', 'PrimalItemConsumable_Berry_Stimberry_C', 'PrimalItemConsumable_Berry_Tintoberry_C', 'PrimalItemConsumable_Veggie_Citronal_C', 'PrimalItemConsumable_Veggie_Longrass_C', 'PrimalItemConsumable_Veggie_Rockarrot_C', 'PrimalItemConsumable_Veggie_Savoroot_C', 'PrimalItemConsumable_Seed_Amarberry_C', 'PrimalItemConsumable_Seed_Azulberry_C', 'PrimalItemConsumable_Seed_DefensePlant_C', 'PrimalItemConsumable_Seed_Mejoberry_C', 'PrimalItemConsumable_Seed_Narcoberry_C', 'PrimalItemConsumable_Seed_Stimberry_C', 'PrimalItemConsumable_Seed_Tintoberry_C', 'PrimalItemConsumable_Seed_Citronal_C', 'PrimalItemConsumable_Seed_Longrass_C', 'PrimalItemConsumable_Seed_Rockarrot_C', 'PrimalItemConsumable_Seed_Savoroot_C', 'PrimalItemConsumable_JellyVenom_C', 'PrimalItemConsumable_Honey_C', 'PrimalItemResource_AmmoniteBlood_C', 'PrimalItemResource_AnglerGel_C', 'PrimalItemResource_BlackPearl_C', 'PrimalItemResource_Charcoal_C', 'PrimalItemResource_Chitin_C', 'PrimalItemResource_ChitinOrKeratin_C', 'PrimalItemResource_ChitinPaste_C', 'PrimalItemResource_Crystal_C', 'PrimalItemResource_Element_C', 'PrimalItemResource_ElementShard_C', 'PrimalItemResource_Fibers_C', 'PrimalItemResource_Flint_C', 'PrimalItemResource_Hair_C', 'PrimalItemResource_Hide_C', 'PrimalItemResource_Horn_C', 'PrimalItemResource_Keratin_C', 'PrimalItemResource_LeechBlood_C', 'PrimalItemResource_Metal_C', 'PrimalItemResource_Obsidian_C', 'PrimalItemResource_Oil_C', 'PrimalItemResource_Pelt_C', 'PrimalItemResource_PeltOrHair_C', 'PrimalItemResource_Polymer_Organic_C', 'PrimalItemResource_RareFlower_C', 'PrimalItemResource_RareMushroom_C', 'PrimalItemResource_Sap_C', 'PrimalItemResource_Silicon_C', 'PrimalItemResource_SquidOil_C', 'PrimalItemResource_Stone_C', 'PrimalItemResource_Thatch_C', 'PrimalItemResource_Wood_C', 'PrimalItemResource_Wool_C', 'PrimalItemConsumable_CactusSap_C', 'PrimalItemConsumable_Seed_PlantSpeciesY_C', 'PrimalItemResource_KeratinSpike_C', 'PrimalItemResource_PreservingSalt_C', 'PrimalItemResource_RawSalt_C', 'PrimalItemResource_Sand_C', 'PrimalItemResource_Silk_C', 'PrimalItemResource_Sulfur_C', 'PrimalItemConsumable_Mushroom_Aquatic_C', 'PrimalItemConsumable_Mushroom_Ascerbic_C', 'PrimalItemConsumable_Mushroom_Auric_C', 'PrimalItemConsumable_NamelessVenom_C', 'PrimalItemConsumable_Seed_PlantSpeciesZ_C', 'PrimalItemResource_CommonMushroom_C', 'PrimalItemResource_ElementOre_C', 'PrimalItemResource_FungalWood_C', 'PrimalItemResource_Gas_C', 'PrimalItemResource_Gem_BioLum_C', 'PrimalItemResource_Gem_Element_C', 'PrimalItemResource_Gem_Fertile_C', 'PrimalItemResource_XenomorphPheromoneGland_C');
UPDATE engrams SET tags = array_append(tags, 'resource') WHERE class_string IN ('PrimalItemResource_ApexDrop_CrabClaw_C', 'PrimalItemResource_CommonMushroom_C', 'PrimalItemResource_Gem_BioLum_C', 'PrimalItemResource_Gem_Element_C', 'PrimalItemResource_ElementOre_C', 'PrimalItemResource_Gem_Fertile_C', 'PrimalItemResource_FungalWood_C', 'PrimalItemResource_Gas_C', 'PrimalItemResource_RawSalt_C', 'PrimalItemResource_PreservingSalt_C', 'PrimalItemResource_Propellant_C', 'PrimalItemResource_Sand_C', 'PrimalItemResource_Sulfur_C', 'PrimalItemResource_ApexDrop_LightningWyvern_C', 'PrimalItemResource_KeratinSpike_C', 'PrimalItemResource_BlackPearl_C', 'PrimalItemResource_ApexDrop_ReaperBarb_C', 'PrimalItemResource_ApexDrop_RockDrake_C', 'PrimalItemResource_ApexDrop_PoisonWyvern_C', 'PrimalItemResource_Oil_C', 'PrimalItemResource_Silicon_C', 'PrimalItemResource_ApexDrop_Basilisk_C', 'PrimalItemResource_ApexDrop_Basilisk_Alpha_C', 'PrimalItemResource_ApexDrop_Boa_C', 'PrimalItemResource_ApexDrop_Argentavis_C', 'PrimalItemResource_ApexDrop_AlphaRaptor_C', 'PrimalItemResource_XenomorphPheromoneGland_C', 'PrimalItemResource_SnailPaste_C', 'PrimalItemResource_ApexDrop_FireWyvern_C', 'PrimalItemResource_ApexDrop_Allo_C', 'PrimalItemResource_ApexDrop_AlphaCarno_C', 'PrimalItemResource_ApexDrop_Spino_C', 'PrimalItemResource_ApexDrop_Sarco_C', 'PrimalItemResource_Horn_C', 'PrimalItemResource_ApexDrop_Megalania_C', 'PrimalItemResource_ApexDrop_AlphaRex_C', 'PrimalItemResource_ApexDrop_Thylaco_C', 'PrimalItemResource_ApexDrop_Yuty_C', 'PrimalItemResource_ApexDrop_Giga_C', 'PrimalItemResource_ApexDrop_Theriz_C', 'PrimalItemResource_Wool_C', 'PrimalItemResource_LeechBlood_C', 'PrimalItemResource_ApexDrop_GasBag_C', 'PrimalItemResource_ApexDrop_Megalodon_C', 'PrimalItemResource_AnglerGel_C', 'PrimalItemResource_ApexDrop_AlphaLeeds_C', 'PrimalItemResource_ApexDrop_AlphaMegalodon_C', 'PrimalItemResource_AmmoniteBlood_C', 'PrimalItemResource_ApexDrop_Basilo_C', 'PrimalItemResource_ApexDrop_AlphaMosasaur_C', 'PrimalItemResource_ApexDrop_AlphaTuso_C', 'PrimalItemResource_ApexDrop_Tuso_C', 'PrimalItemResource_SquidOil_C', 'PrimalItemResource_GreenEnergy_C', 'PrimalItemResource_ApexDrop_Rex_C', 'PrimalItemResource_ApexDrop_Sauro_C', 'PrimalItemResource_ARKBone_C', 'PrimalItemResource_Beeswax_C', 'PrimalItemResource_BlueSap_C', 'PrimalItemResource_Breadfruit_Fresh_C', 'PrimalItemResource_Brick_C', 'PrimalItemResource_Carbon_C', 'PrimalItemResource_Cashew_Fresh_C', 'PrimalItemResource_CashewMilk_C', 'PrimalItemResource_Cement_C', 'PrimalItemResource_Charcoal_C', 'PrimalItemResource_Chitin_C', 'PrimalItemResource_ChitinPaste_C', 'PrimalItemResource_Clay_C', 'PrimalItemResource_Clay_C', 'PrimalItemResource_Claystone_C', 'PrimalItemResource_Coffee_Dry_C', 'PrimalItemResource_Coffee_Fresh_C', 'PrimalItemResource_CondensedGas_C', 'PrimalItemResource_CorruptedPolymer_C', 'PrimalItemResource_Crystal_C', 'PrimalItemResource_Dough_C', 'PrimalItemResource_DriedBarley_C', 'PrimalItemResource_DriedFirewood_C', 'PrimalItemResource_CorruptedWood_C', 'PrimalItemResource_Electronics_C', 'PrimalItemResource_Element_C', 'PrimalItemResource_ElementDust_C', 'PrimalItemResource_ElementRefined_C', 'PrimalItemResource_ElementShard_C', 'PrimalItemResource_Fibers_C', 'PrimalItemResource_Flint_C', 'PrimalItemResource_Flour_C', 'PrimalItemResource_FracturedGem_C', 'PrimalItemResource_FreshFirewood_C', 'PrimalItemResource_Gasoline_C', 'PrimalItemResource_Glass_C', 'PrimalItemResource_Grape_Fresh_C', 'PrimalItemResource_Gunpowder_C', 'PrimalItemResource_Hair_C', 'PrimalItemResource_Hide_C', 'PrimalItemResource_Keratin_C', 'PrimalItemResource_Leather_C', 'PrimalItemResource_Lettuce_Fresh_C', 'PrimalItemResource_Limestone_C', 'PrimalItemResource_Malt_C', 'PrimalItemResource_Metal_C', 'PrimalItemResource_MetalIngot_C', 'PrimalItemResource_Obsidian_C', 'PrimalItemResource_OilMakerBase_C', 'PrimalItemResource_Pelt_C', 'PrimalItemResource_Polymer_C', 'PrimalItemResource_Polymer_Organic_C', 'PrimalItemResource_ProcessedOil_Animal_C', 'PrimalItemResource_ProcessedOil_Seed_C', 'PrimalItemResource_RareDrop_CorruptHeart_C', 'PrimalItemResource_RareFlower_C', 'PrimalItemResource_RareMushroom_C', 'PrimalItemResource_RedSap_C', 'PrimalItemResource_Rice_Dry_C', 'PrimalItemResource_Rubber_C', 'PrimalItemResource_Salt_C', 'PrimalItemResource_Sap_C', 'PrimalItemResource_ScrapMetal_C', 'PrimalItemResource_ScrapMetalIngot_C', 'PrimalItemResource_ShardRefined_C', 'PrimalItemResource_Silicate_C', 'PrimalItemResource_Silk_C', 'PrimalItemResource_Sparkpowder_C', 'PrimalItemResource_SteelIngot_C', 'PrimalItemResource_Stone_C', 'PrimalItemResource_Stone_Magnetite_C', 'PrimalItemResource_SubstrateAbsorbent_C', 'PrimalItemResource_SugarJuice_C', 'PrimalItemResource_Tea_Dry_C', 'PrimalItemResource_Tea_Fresh_C', 'PrimalItemResource_Thatch_C', 'PrimalItemResource_Tobacco_Dry_C', 'PrimalItemResource_Tobacco_Fresh_C', 'PrimalItemResource_Wheat_Dry_C', 'PrimalItemResource_Wheat_Fresh_C', 'PrimalItemResource_Wood_C', 'PrimalItemResource_WoodPlank_C', 'PrimalItemResource_Yeast_C', 'PrimalItemConsumable_JellyVenom_C', 'PrimalItemConsumable_Mushroom_Aquatic_C', 'PrimalItemConsumable_Mushroom_Ascerbic_C', 'PrimalItemConsumable_Mushroom_Auric_C', 'PrimalItemConsumable_NamelessVenom_C', 'PrimalItemConsumable_Honey_C', 'PrimalItemConsumable_Berry_Amarberry_C', 'PrimalItemConsumable_Berry_Azulberry_C', 'PrimalItemConsumable_Berry_Mejoberry_C', 'PrimalItemConsumable_Berry_Narcoberry_C', 'PrimalItemConsumable_Berry_Stimberry_C', 'PrimalItemConsumable_Berry_Tintoberry_C', 'PrimalItemConsumable_BloodPack_C', 'PrimalItemConsumable_BreadLoaf_C', 'PrimalItemConsumable_BugRepellant_C', 'PrimalItemConsumable_CactusSap_C', 'PrimalItemConsumable_Cigarette_C', 'PrimalItemConsumable_CookedBacon_C', 'PrimalItemConsumable_CookedChicken_C', 'PrimalItemConsumable_CookedFillet_C', 'PrimalItemConsumable_CookedFrogLegs_C', 'PrimalItemConsumable_CookedLambChop_C', 'PrimalItemConsumable_CookedMeat_AgedJerky_C', 'PrimalItemConsumable_CookedMeat_AgedJerky_POil_C', 'PrimalItemConsumable_CookedMeat_C', 'PrimalItemConsumable_CookedMeat_Fish_C', 'PrimalItemConsumable_CookedMeat_Jerky_C', 'PrimalItemConsumable_CookedMeat_Jerky_C_P_Oil_C', 'PrimalItemConsumable_CookedPrimeMeat_AgedJerky_C', 'PrimalItemConsumable_CookedPrimeMeat_AgedJerky_POil_C', 'PrimalItemConsumable_CookedPrimeMeat_C', 'PrimalItemConsumable_CookedPrimeMeat_Fish_C', 'PrimalItemConsumable_CookedPrimeMeat_Jerky_C', 'PrimalItemConsumable_CookedPrimeMeat_Jerky_C_P_Oil_C', 'PrimalItemConsumable_CookedRibs_C', 'PrimalItemConsumable_CuredBacon_C', 'PrimalItemConsumable_CureLow_C', 'PrimalItemConsumable_Fertilizer_Bonemeal_C', 'PrimalItemConsumable_Fertilizer_Compost_C', 'PrimalItemConsumable_FreshAnimalFat_C', 'PrimalItemConsumable_FreshBacon_C', 'PrimalItemConsumable_FreshChicken_C', 'PrimalItemConsumable_FreshFillet_C', 'PrimalItemConsumable_FreshFrogLegs_C', 'PrimalItemConsumable_FreshRibs_C', 'PrimalItemConsumable_HoneyLoaf_C', 'PrimalItemConsumableMiracleGro_C', 'PrimalItemConsumable_Narcotic_C', 'PrimalItemConsumable_Preserves_Armarberry_C', 'PrimalItemConsumable_Preserves_Azulberry_C', 'PrimalItemConsumable_Preserves_Mejoberry_C', 'PrimalItemConsumable_Preserves_Tintoberry_C', 'PrimalItemConsumable_RawMeat_C', 'PrimalItemConsumable_RawMeat_Fish_C', 'PrimalItemConsumable_RawMutton_C', 'PrimalItemConsumable_RawPrimeMeat_C', 'PrimalItemConsumable_RawPrimeMeat_Fish_C', 'PrimalItemConsumable_SpoiledMeat_C', 'PrimalItemConsumable_Sugar_C', 'PrimalItemConsumable_SweetVeggieCake_C', 'PrimalItemConsumable_Veggie_Barley_C', 'PrimalItemConsumable_Veggie_Breadfruit_C', 'PrimalItemConsumable_Veggie_Citronal_C', 'PrimalItemConsumable_Veggie_Coffee_C', 'PrimalItemConsumable_Veggie_CookedRice_C', 'PrimalItemConsumable_Veggie_DriedTea_C', 'PrimalItemConsumable_Veggie_DriedTobacco_C', 'PrimalItemConsumable_Veggie_DriedWheat_C', 'PrimalItemConsumable_Veggie_FreshCashew_C', 'PrimalItemConsumable_Veggie_FreshLettuce_C', 'PrimalItemConsumable_Veggie_FreshRice_C', 'PrimalItemConsumable_Veggie_Grape_C', 'PrimalItemConsumable_Veggie_GroundCashew_C', 'PrimalItemConsumable_Veggie_Longrass_C', 'PrimalItemConsumable_Veggie_Rockarrot_C', 'PrimalItemConsumable_Veggie_Savoroot_C', 'PrimalItemConsumable_Veggie_Sugar_C', 'PrimalItemConsumable_Veggie_Tea_C', 'PrimalItemConsumable_Veggie_Tobacco_C', 'PrimalItemConsumable_Veggie_Tomato_C', 'PrimalItemConsumable_Veggie_Wheat_C', 'PrimalItemConsumable_WyvernMilk_C');
UPDATE engrams SET tags = array_append(tags, 'kibble') WHERE class_string LIKE 'PrimalItemConsumable_Kibble_%';
UPDATE engrams SET tags = array_append(tags, 'egg') WHERE class_string LIKE 'PrimalItemConsumable_Egg_%';

ALTER TABLE engrams DROP COLUMN can_blueprint;

CREATE OR REPLACE VIEW blueprints AS (SELECT object_id, label, tableoid, min_version, last_update, mod_id, path, class_string, availability, tags FROM creatures) UNION (SELECT object_id, label, tableoid, min_version, last_update, mod_id, path, class_string, availability, tags FROM engrams) UNION (SELECT object_id, label, tableoid, min_version, last_update, mod_id, path, class_string, availability, tags FROM loot_sources);

ALTER TABLE email_addresses ADD COLUMN group_key_precision INTEGER;
UPDATE email_addresses SET group_key_precision = 2;
ALTER TABLE email_addresses ALTER COLUMN group_key_precision SET NOT NULL;

DROP FUNCTION group_key_for_email(email);
CREATE OR REPLACE FUNCTION group_key_for_email(p_address email, p_precision INTEGER) RETURNS hex AS $$
DECLARE
	v_user TEXT;
	v_domain TEXT;
	v_kvalue TEXT;
BEGIN
	v_user := SUBSTRING(p_address, '^([^@]+)@.+$');
	v_domain := SUBSTRING(p_address, '^[^@]+@(.+)$');
	
	IF LENGTH(v_user) <= p_precision THEN
		v_kvalue := '@' || v_domain;
	ELSE
		v_kvalue := SUBSTRING(v_user, 1, p_precision) || '*@' || v_domain;
	END IF;
	
	RETURN MD5(LOWER(v_kvalue));
END;
$$ LANGUAGE 'plpgsql' IMMUTABLE;

CREATE OR REPLACE FUNCTION uuid_for_email(p_address email) RETURNS UUID AS $$
DECLARE
	v_uuid UUID;
BEGIN
	SELECT email_id INTO v_uuid FROM email_addresses WHERE group_key = group_key_for_email(p_address, email_addresses.group_key_precision) AND CRYPT(LOWER(p_address), address) = address;
	IF FOUND THEN
		RETURN v_uuid;
	ELSE
		RETURN NULL;
	END IF;
END;
$$ LANGUAGE 'plpgsql' STABLE;

CREATE OR REPLACE FUNCTION uuid_for_email(p_address email, p_create BOOLEAN) RETURNS UUID AS $$
DECLARE
	v_uuid UUID;
	v_precision INTEGER;
	k_target_precision CONSTANT INTEGER := 5;
BEGIN
	v_uuid := uuid_for_email(p_address);
	IF v_uuid IS NULL THEN
		IF p_create = TRUE THEN
			INSERT INTO email_addresses (address, group_key, group_key_precision) VALUES (CRYPT(LOWER(p_address), GEN_SALT('bf')), group_key_for_email(p_address, k_target_precision), k_target_precision) RETURNING email_id INTO v_uuid;
		END IF;
	ELSE
		SELECT group_key_precision INTO v_precision FROM email_addresses WHERE email_id = v_uuid;
		IF v_precision != k_target_precision THEN
			UPDATE email_addresses SET group_key = group_key_for_email(p_address, k_target_precision), group_key_precision = k_target_precision WHERE email_id = v_uuid;
		END IF;
	END IF;
	RETURN v_uuid;	
END;
$$ LANGUAGE 'plpgsql' VOLATILE;
